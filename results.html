<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Results</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      position: relative;
    }
    
    /* Top Buttons */
    .final-timer {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #ffbd00;
      color: #000;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      z-index: 100;
      font-family: monospace;
    }
    
    .export-button {
      position: fixed;
      top: 20px;
      left: 20px;
      background: #00e054;
      color: #000;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      border: none;
      z-index: 100;
      transition: transform 0.2s;
      font-family: monospace;
    }
    
    .export-button:hover {
      transform: translateY(-2px);
      background: #00ff5e;
    }
    
    /* Header */
    .header-info {
      text-align: center;
      margin: 60px 0 40px;
    }
    
    h1 {
      color: #00e054;
      margin: 0;
      font-size: 2.5rem;
      text-shadow: 0 0 20px rgba(0, 224, 84, 0.2);
    }
    
    .sub-info {
      color: #888;
      margin-top: 10px;
    }

    /* Preferences Section */
    .preferences {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #333;
      margin-bottom: 30px;
    }
    
    .pref-row {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .pref-item strong {
      color: #00e054;
      display: block;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }
    
    /* Filter Controls */
    .controls-section {
      background: #1e1e1e;
      padding: 25px;
      border-radius: 12px;
      border: 1px solid #333;
      margin-bottom: 30px;
    }
    
    .control-group {
      margin-bottom: 25px;
    }
    
    .control-group:last-child {
      margin-bottom: 0;
    }
    
    .control-title {
      color: #00e054;
      font-size: 1.1rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .platform-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .platform-checkbox {
      display: none;
    }
    
    .platform-label {
      background: #2a2a2a;
      color: #aaa;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid #333;
      transition: all 0.2s;
      font-size: 0.85rem;
      user-select: none;
    }
    
    .platform-label:hover {
      border-color: #00e054;
      color: #fff;
    }
    
    .platform-checkbox:checked + .platform-label {
      background: #00e054;
      color: #000;
      border-color: #00e054;
      font-weight: bold;
    }
    
    /* Sort Buttons */
    .sort-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .sort-btn {
      background: #2a2a2a;
      color: #e0e0e0;
      padding: 10px 20px;
      border: 2px solid #333;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sort-btn:hover {
      border-color: #00e054;
      color: #fff;
    }
    
    .sort-btn.active {
      background: #ffbd00;
      color: #000;
      border-color: #ffbd00;
      font-weight: bold;
    }
    
    .sort-btn.green {
      background: #00e054;
      color: #000;
      border-color: #00e054;
    }
    
    .sort-btn.red {
      background: #ff4444;
      color: #fff;
      border-color: #ff4444;
    }
    
    .sort-btn.red:hover {
      background: #ff6666;
      border-color: #ff6666;
    }
    
    /* Results Counter */
    .results-counter {
      text-align: center;
      color: #00e054;
      font-size: 1.2rem;
      margin-bottom: 20px;
      font-weight: bold;
    }
    
    /* Grid */
    .movies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
    }
    
    .movie-card {
      background: #1e1e1e;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #333;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s, border-color 0.2s;
    }
    
    .movie-card:hover {
      transform: translateY(-5px);
      border-color: #00e054;
    }
    
    .movie-card.hidden {
      display: none;
    }
    
    .movie-poster {
      width: 100%;
      aspect-ratio: 2/3;
      object-fit: cover;
      background: #0a0a0a;
    }
    
    .movie-info {
      padding: 15px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .title {
      font-weight: bold;
      color: #fff;
      margin-bottom: 5px;
      font-size: 1rem;
    }
    
    .meta {
      font-size: 0.8rem;
      color: #aaa;
    }
    
    .rating {
      color: #ffbd00;
      font-weight: bold;
      margin: 5px 0;
    }
    
    .reason {
      font-size: 0.8rem;
      font-style: italic;
      color: #888;
      background: rgba(255,255,255,0.05);
      padding: 5px;
      border-radius: 4px;
      margin-top: 5px;
    }
    
    .streaming-sec {
      margin-top: auto;
      padding-top: 10px;
      border-top: 1px dashed #333;
    }
    
    .platform {
      display: inline-block;
      background: #00e054;
      color: #000;
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 4px;
      margin: 2px;
      font-weight: bold;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: #121212;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      flex-direction: column;
    }
    
    .spinner {
      color: #00e054;
      font-size: 2rem;
      margin-bottom: 20px;
      font-family: monospace;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .header-info {
        margin-top: 80px;
      }
      
      .movies-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .platform-filters, .sort-buttons {
        justify-content: center;
      }
      
      .final-timer, .export-button {
        position: static;
        margin: 10px auto;
        display: block;
        width: fit-content;
      }
    }
    
    @media (max-width: 480px) {
      .movies-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <div id="loader" class="loading-overlay">
    <div class="spinner">‚è≥ Loading data...</div>
    <div style="color: #888;">Fetching latest recommendations</div>
  </div>

  <button class="export-button" onclick="exportToExcel()">üìä Export to Excel</button>
  <div class="final-timer" id="timerDisplay">--:--</div>

  <div class="container">
    <div class="header-info">
      <h1 id="pageTitle">Recommendations</h1>
      <div class="sub-info" id="pageSub">Detected Country: --</div>
    </div>

    <div class="preferences">
      <div class="pref-row">
        <div class="pref-item">
          <strong>‚ù§Ô∏è Favorite Genres</strong>
          <span id="p-genres">-</span>
        </div>
        <div class="pref-item">
          <strong>üé¨ Top Directors</strong>
          <span id="p-directors">-</span>
        </div>
        <div class="pref-item">
          <strong>üìÖ Eras</strong>
          <span id="p-decades">-</span>
        </div>
      </div>
    </div>

    <!-- Filter and Sort Controls -->
    <div class="controls-section">
      <!-- Streaming Platform Filters -->
      <div class="control-group">
        <div class="control-title">üé¨ Filter by Streaming Platform</div>
        <div class="platform-filters" id="platformFilters">
          <!-- Platforms will be dynamically added here -->
        </div>
        <button class="sort-btn red" onclick="clearAllFilters()" style="margin-top: 15px;">
          üóëÔ∏è Clear Filters
        </button>
      </div>

      <!-- Sort Options -->
      <div class="control-group">
        <div class="control-title">üìä Sort Movies</div>
        <div class="sort-buttons">
          <button class="sort-btn" onclick="sortMovies('rating-desc')">
            ‚≠ê Rating ‚Üì
          </button>
          <button class="sort-btn" onclick="sortMovies('rating-asc')">
            ‚≠ê Rating ‚Üë
          </button>
          <button class="sort-btn" onclick="sortMovies('runtime-desc')">
            ‚è±Ô∏è Runtime ‚Üì
          </button>
          <button class="sort-btn" onclick="sortMovies('runtime-asc')">
            ‚è±Ô∏è Runtime ‚Üë
          </button>
          <button class="sort-btn green active" onclick="sortMovies('original')">
            üîÑ Original Order
          </button>
        </div>
      </div>
    </div>

    <!-- Results Counter -->
    <div class="results-counter" id="resultsCounter">
      Showing 0 of 0 movies
    </div>

    <!-- Movies Grid -->
    <div class="movies-grid" id="grid"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // Global variables
    const username = window.location.pathname.substring(1); 
    let moviesData = [];
    let originalMoviesData = [];
    let selectedPlatforms = new Set();
    let currentSort = 'original';
    let userCountryName = 'Global';
    let userCountryCode = 'US';

    document.title = `Results for ${username}`;
    document.getElementById('pageTitle').textContent = `For: ${username}`;

    // Convert country code to flag emoji
    function countryCodeToFlag(countryCode) {
      const codePoints = countryCode
        .toUpperCase()
        .split('')
        .map(char => 127397 + char.charCodeAt());
      return String.fromCodePoint(...codePoints);
    }

    // Detect country automatically
    window.onload = async () => {
      try {
        const res = await fetch('https://ipapi.co/json/');
        const data = await res.json();
        userCountryCode = data.country_code || 'US';
        userCountryName = data.country_name || 'Global';
      } catch (e) {}
    };

    // Helper: Time Formatter
    function formatTime(ms) {
      if (!ms) return "00:00";
      const m = Math.floor(ms / 60000);
      const s = Math.floor((ms % 60000) / 1000);
      const mil = Math.floor((ms % 1000) / 10);
      return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}.${mil.toString().padStart(2,'0')}`;
    }

    // Initialize app
    async function init() {
      const cacheKey = `lb_data_${username}`;
      const cached = localStorage.getItem(cacheKey);
      
      if (cached) {
        try {
          const parsed = JSON.parse(cached);
          if (parsed.data && parsed.data.recommendations) {
            render(parsed.data);
            if (parsed.executionTime) {
              document.getElementById('timerDisplay').textContent = "‚è±Ô∏è " + formatTime(parsed.executionTime);
            }
            document.getElementById('loader').style.display = 'none';
            return;
          }
        } catch(e) {
          console.error("Cache parse error", e);
        }
      }

      // Fetch from API if no cache
      const start = new Date();
      try {
        const res = await fetch('/api/recommend', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ 
            username: username, 
            country: userCountryCode,
            include_streaming: true
          })
        });
        
        const data = await res.json();
        
        if (!res.ok) throw new Error(data.error);
        
        const timeTaken = new Date() - start;
        render(data);
        document.getElementById('timerDisplay').textContent = "‚è±Ô∏è " + formatTime(timeTaken);
        
      } catch(e) {
        document.querySelector('.spinner').textContent = "‚ùå Error";
        document.querySelector('.loading-overlay div:last-child').textContent = e.message;
      } finally {
        if (document.getElementById('grid').children.length > 0) {
          document.getElementById('loader').style.display = 'none';
        }
      }
    }

    // Render data
    function render(data) {
      moviesData = data.recommendations || [];
      originalMoviesData = [...moviesData];
      userCountryName = data.country_name || userCountryName;
      if (data.country_code) {
        userCountryCode = data.country_code;
      }
      
      document.getElementById('pageSub').textContent = 
        `Based on your profile. Region: ${userCountryName} ${countryCodeToFlag(userCountryCode)}`;
      
      // Render preferences
      document.getElementById('p-genres').textContent = 
        (data.preferences?.genres || []).join(', ') || 'N/A';
      document.getElementById('p-directors').textContent = 
        (data.preferences?.directors || []).join(', ') || 'N/A';
      document.getElementById('p-decades').textContent = 
        (data.preferences?.decades || []).join(', ') || 'N/A';

      // Extract all unique streaming platforms
      const allPlatforms = new Set();
      moviesData.forEach(m => {
        (m.streaming || []).forEach(p => allPlatforms.add(p));
      });

      // Render platform filters
      const platformContainer = document.getElementById('platformFilters');
      platformContainer.innerHTML = '';
      
      const sortedPlatforms = Array.from(allPlatforms).sort();
      sortedPlatforms.forEach(platform => {
        const id = `platform-${platform.replace(/\s+/g, '-')}`;
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = id;
        checkbox.className = 'platform-checkbox';
        checkbox.addEventListener('change', () => togglePlatform(platform));
        
        const label = document.createElement('label');
        label.htmlFor = id;
        label.className = 'platform-label';
        label.textContent = platform;
        
        platformContainer.appendChild(checkbox);
        platformContainer.appendChild(label);
      });

      // Render movies
      renderMovies();
    }

    // Render movies to grid
    function renderMovies() {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      
      let visibleCount = 0;
      
      moviesData.forEach((m, index) => {
        const div = document.createElement('div');
        div.className = 'movie-card';
        div.dataset.index = index;
        
        // Apply filters
        if (selectedPlatforms.size > 0) {
          const moviePlatforms = m.streaming || [];
          const hasSelectedPlatform = moviePlatforms.some(p => selectedPlatforms.has(p));
          
          if (!hasSelectedPlatform) {
            div.classList.add('hidden');
          } else {
            visibleCount++;
          }
        } else {
          visibleCount++;
        }
        
        const platforms = (m.streaming || [])
          .map(p => `<span class="platform">${p}</span>`)
          .join('');
        
        const streamHtml = platforms 
          ? `<div class="streaming-sec">${platforms}</div>` 
          : `<div class="streaming-sec" style="color: #ff4444; border-color: #ff4444; border-top: 1px dashed #ff4444;">‚ùå Movie not available on streaming services in ${userCountryName} ${countryCodeToFlag(userCountryCode)}</div>`;
        
        const poster = m.poster || 'https://via.placeholder.com/300x450?text=No+Poster';
        const runtime = m.runtime ? `${m.runtime} min` : 'N/A';

        div.innerHTML = `
          <img src="${poster}" class="movie-poster" loading="lazy" alt="${m.title}">
          <div class="movie-info">
            <div class="title">${m.title}</div>
            <div class="meta">${m.year || 'N/A'} ‚Ä¢ ${m.director || 'Unknown'}</div>
            <div class="meta">‚è±Ô∏è ${runtime}</div>
            <div class="rating">‚≠ê ${m.rating_tmdb || 'N/A'}</div>
            <div class="reason">üí° ${m.reason || 'Recommended for you'}</div>
            ${streamHtml}
          </div>
        `;
        
        grid.appendChild(div);
      });
      
      // Update counter
      document.getElementById('resultsCounter').textContent = 
        `Showing ${visibleCount} of ${moviesData.length} movies`;
    }

    // Toggle platform filter
    function togglePlatform(platform) {
      if (selectedPlatforms.has(platform)) {
        selectedPlatforms.delete(platform);
      } else {
        selectedPlatforms.add(platform);
      }
      renderMovies();
    }

    // Clear all filters
    function clearAllFilters() {
      selectedPlatforms.clear();
      
      // Uncheck all checkboxes
      document.querySelectorAll('.platform-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      renderMovies();
    }

    // Sort movies
    function sortMovies(type) {
      // Update active button
      document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      currentSort = type;
      
      switch(type) {
        case 'rating-desc':
          moviesData.sort((a, b) => (b.rating_tmdb || 0) - (a.rating_tmdb || 0));
          break;
        case 'rating-asc':
          moviesData.sort((a, b) => (a.rating_tmdb || 0) - (b.rating_tmdb || 0));
          break;
        case 'runtime-desc':
          moviesData.sort((a, b) => (b.runtime || 0) - (a.runtime || 0));
          break;
        case 'runtime-asc':
          moviesData.sort((a, b) => (a.runtime || 0) - (b.runtime || 0));
          break;
        case 'original':
          moviesData = [...originalMoviesData];
          break;
      }
      
      renderMovies();
    }

    // Export to Excel
    function exportToExcel() {
      if (!moviesData.length) {
        alert('No data to export');
        return;
      }
      
      const ws = XLSX.utils.json_to_sheet(moviesData.map(m => ({
        Title: m.title,
        Year: m.year,
        Rating: m.rating_tmdb,
        Runtime: m.runtime,
        Director: m.director,
        Genres: (m.genres || []).join(', '),
        Reason: m.reason,
        Streaming: (m.streaming || []).join(', ')
      })));
      
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Recommendations");
      XLSX.writeFile(wb, `recommendations_${username}_${Date.now()}.xlsx`);
    }

    // Run initialization
    init();
  </script>
</body>
</html>
