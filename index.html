<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Letterboxd Recommender Pro</title>
  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 40px 20px;
    }
    .input-section {
      background: #1e1e1e;
      padding: 3rem;
      border-radius: 16px;
      border: 1px solid #333;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    h1 {
      font-size: 2.2rem;
      margin-bottom: 0.5rem;
      color: #00e054;
      text-shadow: 0 0 15px rgba(0, 224, 84, 0.4);
    }
    input {
      padding: 14px;
      border-radius: 8px;
      border: 1px solid #444;
      background: #222;
      color: #fff;
      width: 280px;
      margin-top: 20px;
      font-family: inherit;
      font-size: 1rem;
    }
    button {
      padding: 14px 28px;
      background: #00e054;
      color: #000;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-family: inherit;
      margin-top: 15px;
      font-size: 1rem;
      transition: all 0.2s;
    }
    button:hover { background: #00ff5e; transform: scale(1.05); }
    button:disabled { background: #555; cursor: wait; transform: none; }
    
    .loading-box { display: none; margin-top: 25px; }
    .timer { font-size: 1.5rem; color: #ffbd00; font-weight: bold; margin-bottom: 10px;}
    .status { color: #888; font-size: 0.9rem; }
    .progress-wrap {
      width: 100%;
      max-width: 320px;
      margin: 10px auto 0;
      text-align: left;
    }
    .progress-label {
      font-size: 0.78rem;
      color: #777;
      margin-bottom: 6px;
    }
    .progress-track {
      width: 100%;
      height: 10px;
      background: #2a2a2a;
      border: 1px solid #3b3b3b;
      border-radius: 999px;
      overflow: hidden;
    }
    .progress-fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #00a53f, #00e054);
      transition: width 0.25s ease;
    }
    .live-log-box {
      width: 100%;
      max-width: 520px;
      margin: 12px auto 0;
      background: #151515;
      border: 1px solid #303030;
      border-radius: 8px;
      padding: 10px;
      text-align: left;
      max-height: 180px;
      overflow-y: auto;
      display: none;
    }
    .live-log-line {
      color: #9f9f9f;
      font-size: 0.78rem;
      white-space: pre-wrap;
      line-height: 1.35;
      margin-bottom: 4px;
    }
    
    .recommendations-live {
      margin-top: 40px;
      width: 100%;
      max-width: 900px;
      display: none;
    }
    .recommendations-live h2 {
      color: #00e054;
      font-size: 1.5rem;
      margin-bottom: 20px;
      text-align: center;
    }
    .recommendations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
    }
    .movie-card {
      background: #1e1e1e;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #333;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s, border-color 0.2s;
    }
    .movie-card:hover {
      transform: translateY(-5px);
      border-color: #00e054;
    }
    .movie-poster {
      width: 100%;
      aspect-ratio: 2/3;
      object-fit: cover;
      background: #0a0a0a;
    }
    .movie-info {
      padding: 15px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .title {
      font-weight: bold;
      color: #fff;
      margin-bottom: 5px;
      font-size: 1rem;
    }
    .meta {
      font-size: 0.8rem;
      color: #aaa;
    }
    .rating {
      color: #ffbd00;
      font-weight: bold;
      margin: 5px 0;
    }
    .reason {
      font-size: 0.8rem;
      font-style: italic;
      color: #888;
      background: rgba(255,255,255,0.05);
      padding: 5px;
      border-radius: 4px;
      margin-top: 5px;
    }
    .streaming-sec {
      margin-top: auto;
      padding-top: 10px;
      border-top: 1px dashed #333;
    }
    .platform {
      display: inline-block;
      background: #00e054;
      color: #000;
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 4px;
      margin: 2px;
      font-weight: bold;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <div class="input-section">
    <h1>üé¨ Letterboxd Recommender</h1>
    <div style="color: #666; margin-bottom: 15px; font-size: 0.85rem;">
      Coded by <a href="https://github.com/based-on-what/letterboxd-recommender" target="_blank" rel="noopener noreferrer" style="color: #00e054; text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#00ff5e'" onmouseout="this.style.color='#00e054'">@based-on-what</a>
    </div>
    <div style="color: #888; margin-bottom: 20px; font-size: 0.9rem;">
      Enter your username to generate a permanent link.
    </div>
    <div id="country-info" style="color: #888; margin-bottom: 20px; font-size: 0.9rem;">
      üìç Searching movie recommendations in: -- üåç
    </div>
    
    <input type="text" id="username" placeholder="Username (e.g. davidehrlich)" onkeypress="if(event.key==='Enter')startProcess()">
    <br>
    <button id="btn" onclick="startProcess()">Generate Recommendations</button>
    <button id="recommendations-btn" style="display: none; width: 280px; margin: 0 auto; margin-top: 30px;" onclick="navigateToRecommendations()"></button>

    <div id="loading" class="loading-box">
      <div class="timer" id="chronometer">00:00.00</div>
      <div class="status">Analyzing profile & fetching data...</div>
      <div class="progress-wrap">
        <div class="progress-label" id="progress-label">Progress: 0%</div>
        <div class="progress-track">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>
      <div id="live-log-box" class="live-log-box"></div>
    </div>
  </div>

  <div class="recommendations-live" id="recommendations-live">
    <h2>üé¨ Recommendations Found</h2>
    <div class="recommendations-grid" id="recommendations-grid"></div>
  </div>

  <script>
    let startTime;
    let timerInterval;
    let userCountry = 'CL';
    let userCountryName = 'Global';
    let eventSource; // Track EventSource connection
    let recsEventSource; // Track recommendations EventSource connection
    let statusEventSource; // Track status EventSource connection
    let activeRequestId = null;
    let liveRecommendations = []; // Store recommendations shown in real-time
    let shownMovieIds = new Set(); // Track movie IDs already displayed to prevent duplicates
    let totalSeedFilms = 0;
    let processedSeedFilms = 0;

    // Convert an ISO country code into its flag emoji.
    function countryCodeToFlag(countryCode) {
      const codePoints = countryCode
        .toUpperCase()
        .split('')
        .map(char => 127397 + char.charCodeAt());
      return String.fromCodePoint(...codePoints);
    }

    // Detect the visitor's country to personalize streaming region.
    window.onload = async () => {
      try {
        const res = await fetch('https://ipapi.co/json/');
        const data = await res.json();
        userCountry = data.country_code || 'CL';
        userCountryName = data.country_name || 'Global';
        
        const flagEmoji = countryCodeToFlag(userCountry);
        document.getElementById('country-info').textContent = 
          `üìç Searching movie recommendations in: ${userCountryName} ${flagEmoji}`;
      } catch (e) {}
    };

    // Update the on-screen chronometer while recommendations are generated.
    function updateTimer() {
      const diff = new Date() - startTime;
      const m = Math.floor((diff % 3600000) / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      const ms = Math.floor((diff % 1000) / 10);
      document.getElementById('chronometer').textContent = 
        `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
    }

    // Connect to SSE logs stream
    function connectToLogsStream(requestId) {
      if (eventSource) {
        eventSource.close();
      }
      
      eventSource = new EventSource(`/api/logs-stream?request_id=${encodeURIComponent(requestId)}`);
      
      eventSource.onmessage = function(event) {
        if (event.data && event.data !== 'heartbeat') {
          console.log('[SERVER]', event.data);
          addLiveLogLine(event.data);
          updateProgressFromLog(event.data);
        }
      };
      
      eventSource.onerror = function() {
        // Connection error - try to reconnect
        console.warn('[LOGS] Connection lost, will attempt to reconnect...');
      };
    }

    // Connect to status stream to track seed-film processing.
    function connectToStatusStream(requestId) {
      if (statusEventSource) {
        statusEventSource.close();
      }

      statusEventSource = new EventSource(`/api/status-stream?request_id=${encodeURIComponent(requestId)}`);
      statusEventSource.onmessage = function(event) {
        if (!event.data || event.data === 'heartbeat') return;
        try {
          const payload = JSON.parse(event.data);
          if (payload.status === 'complete') {
            setProgress(98, 'Finalizing recommendations...');
            disconnectFromStatusStream();
            return;
          }

          if (payload.title) {
            processedSeedFilms += 1;
            const ratio = totalSeedFilms > 0 ? Math.min(1, processedSeedFilms / totalSeedFilms) : 0;
            const pct = 60 + Math.round(ratio * 35);
            setProgress(pct, `Analyzing favorites: ${processedSeedFilms}/${Math.max(totalSeedFilms, processedSeedFilms)}`);
            addLiveLogLine(`Analyzing: ${payload.title} (${payload.user_rating || 0}‚òÖ)`);
          }
        } catch (_e) {}
      };
    }

    function disconnectFromStatusStream() {
      if (statusEventSource) {
        statusEventSource.close();
        statusEventSource = null;
      }
    }

    function setProgress(percent, labelText) {
      const clamped = Math.max(0, Math.min(100, percent));
      document.getElementById('progress-fill').style.width = `${clamped}%`;
      document.getElementById('progress-label').textContent = labelText || `Progress: ${clamped}%`;
    }

    function addLiveLogLine(message) {
      const box = document.getElementById('live-log-box');
      if (!message || message === 'heartbeat') return;
      box.style.display = 'block';
      const line = document.createElement('div');
      line.className = 'live-log-line';
      line.textContent = `[SERVER] ${message}`;
      box.appendChild(line);
      while (box.children.length > 40) {
        box.removeChild(box.firstChild);
      }
      box.scrollTop = box.scrollHeight;
    }

    function updateProgressFromLog(message) {
      const text = String(message || '');
      const starMatch = text.match(/Total films with 4\+ stars:\s*(\d+)/i);
      if (starMatch) {
        totalSeedFilms = parseInt(starMatch[1], 10) || 0;
        processedSeedFilms = 0;
        setProgress(60, `Analyzing favorites: 0/${totalSeedFilms}`);
        return;
      }

      if (/Fetched\s+\d+\s+films/i.test(text)) {
        setProgress(25, 'Profile fetched, enriching with TMDB...');
        return;
      }

      if (/Enrichment completed/i.test(text)) {
        setProgress(55, 'Preferences detected, preparing recommendations...');
        return;
      }

      if (/Returning\s+\d+\s+recommendations/i.test(text) || /ANALYSIS COMPLETE/i.test(text)) {
        setProgress(100, 'Progress: 100%');
      }
    }

    function resetLiveProgressUi() {
      totalSeedFilms = 0;
      processedSeedFilms = 0;
      setProgress(0, 'Progress: 0%');
      const box = document.getElementById('live-log-box');
      box.innerHTML = '';
      box.style.display = 'none';
    }

    // Disconnect from logs stream
    function disconnectFromLogsStream() {
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
    }

    // Connect to recommendations stream
    function connectToRecommendationsStream(requestId) {
      if (recsEventSource) {
        recsEventSource.close();
      }
      
      recsEventSource = new EventSource(`/api/recommendations-stream?request_id=${encodeURIComponent(requestId)}`);
      
      recsEventSource.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          
          if (data.status === 'complete') {
            recsEventSource.close();
            recsEventSource = null;
            return;
          }
          
          // Add recommendation to live display
          liveRecommendations.push(data);
          addRecommendationToGrid(data);
          
        } catch (e) {
          console.error('[RECS] Error parsing recommendation:', e);
        }
      };
      
      recsEventSource.onerror = function() {
        console.warn('[RECS] Connection lost');
      };
    }

    // Disconnect from recommendations stream
    function disconnectFromRecommendationsStream() {
      if (recsEventSource) {
        recsEventSource.close();
        recsEventSource = null;
      }
    }

    // Add a movie card to the live recommendations grid
    function addRecommendationToGrid(movie) {
      // Prevent duplicates
      const movieId = movie.title + '_' + movie.year;
      if (shownMovieIds.has(movieId)) {
        console.log('[DUPLICATE PREVENTED]', movie.title);
        return;
      }
      shownMovieIds.add(movieId);
      
      const grid = document.getElementById('recommendations-grid');
      const liveSection = document.getElementById('recommendations-live');
      
      // Show the section if hidden
      if (liveSection.style.display === 'none') {
        liveSection.style.display = 'block';
      }
      
      const card = document.createElement('div');
      card.className = 'movie-card';
      
      const posterUrl = movie.poster || 'https://via.placeholder.com/300x450?text=No+Poster';
      const runtime = movie.runtime ? `${movie.runtime} min` : 'N/A';
      const director = movie.director || 'Unknown';

      // Prepare streaming HTML identical to results.html
      let streamingHtml = '';
      if (movie.streaming && movie.streaming.length > 0) {
        const platforms = movie.streaming
          .map(p => `<span class="platform">${p}</span>`)
          .join('');
        streamingHtml = `<div class="streaming-sec">${platforms}</div>`;
      } else {
        const flagEmoji = countryCodeToFlag(userCountry);
        streamingHtml = `<div class="streaming-sec" style="color: #ff4444; border-color: #ff4444; border-top: 1px dashed #ff4444;">‚ùå Movie not available on streaming services in ${userCountryName} ${flagEmoji}</div>`;
      }

      card.innerHTML = `
        <img src="${posterUrl}" class="movie-poster" loading="lazy" alt="${movie.title}" onerror="this.src='https://via.placeholder.com/300x450?text=No+Poster'">
        <div class="movie-info">
          <div class="title">${movie.title}</div>
          <div class="meta">${movie.year || 'N/A'} ‚Ä¢ ${director}</div>
          <div class="meta">‚è±Ô∏è ${runtime}</div>
          <div class="rating">‚≠ê ${movie.rating_tmdb || 'N/A'}</div>
          <div class="reason">üí° ${movie.reason || 'Recommended for you'}</div>
          ${streamingHtml}
        </div>
      `;
      
      grid.appendChild(card);
    }

    // Clear live recommendations display
    function clearLiveRecommendations() {
      const grid = document.getElementById('recommendations-grid');
      const liveSection = document.getElementById('recommendations-live');
      
      grid.innerHTML = '';
      liveSection.style.display = 'none';
      liveRecommendations = [];
      shownMovieIds.clear(); // Clear displayed IDs
    }

    // Kick off the recommendation workflow for a provided username.
    async function startProcess() {
      const username = document.getElementById('username').value.trim();
      if (!username) return alert('Please enter a username');

      // Clear previous results
      clearLiveRecommendations();

      // UI changes
      document.getElementById('btn').disabled = true;
      document.getElementById('loading').style.display = 'block';
      
      activeRequestId = (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : `req-${Date.now()}-${Math.random().toString(16).slice(2)}`;

      // Connect to logs stream BEFORE starting the request
      connectToLogsStream(activeRequestId);
      connectToStatusStream(activeRequestId);
      resetLiveProgressUi();
      setProgress(5, 'Starting analysis...');
      
      // Connect to recommendations stream for real-time updates
      connectToRecommendationsStream(activeRequestId);
      
      startTime = new Date();
      timerInterval = setInterval(updateTimer, 50);

      try {
        // Fetch data here
        const response = await fetch('/api/recommend', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({username, country: userCountry, request_id: activeRequestId})
        });
        
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Unknown error');
        if (data.request_id) {
          activeRequestId = data.request_id;
        }

        const endTime = new Date();
        const totalTime = endTime - startTime;

        // Save data to localStorage so results page can render instantly without re-fetching
        // We use a specific key for this user
        const cacheKey = `lb_data_${username}`;
        localStorage.setItem(cacheKey, JSON.stringify({
          data: data,
          timestamp: new Date().getTime(),
          executionTime: totalTime // Save the timer result
        }));

        // Hide loading and show recommendations button
        clearInterval(timerInterval);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('btn').style.display = 'none';
        
        // Disconnect from logs stream
        disconnectFromLogsStream();
        
        // Disconnect from recommendations stream
        disconnectFromRecommendationsStream();
        disconnectFromStatusStream();
        setProgress(100, 'Progress: 100%');
        
        // Show and configure the recommendations button
        const recBtn = document.getElementById('recommendations-btn');
        recBtn.textContent = `Get ${username}'s recommendations üé¨`;
        recBtn.style.display = 'block';
        
        // Store username for navigation
        window.currentUsername = username;

      } catch (e) {
        clearInterval(timerInterval);
        document.getElementById('btn').disabled = false;
        document.getElementById('loading').style.display = 'none';
        disconnectFromLogsStream();
        disconnectFromRecommendationsStream();
        disconnectFromStatusStream();
        alert("Error: " + e.message);
      }
    }

    // Redirect to the results page for the current user.
    function navigateToRecommendations() {
      if (window.currentUsername) {
        window.location.href = `/${window.currentUsername}`;
      }
    }

    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
      disconnectFromLogsStream();
      disconnectFromRecommendationsStream();
      disconnectFromStatusStream();
    });
  </script>
</body>
</html>
